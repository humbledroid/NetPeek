name: iOS Build & Simulator Test

on:
  push:
    branches: [master, main]
  pull_request:
    branches: [master, main]
  workflow_dispatch:

jobs:
  ios-build:
    runs-on: macos-14          # Apple Silicon — required for iosSimulatorArm64
    timeout-minutes: 60

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Cache Gradle + Kotlin Native toolchain
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
            ~/.konan
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle.kts', '**/libs.versions.toml') }}
          restore-keys: ${{ runner.os }}-gradle-

      - name: Make gradlew executable
        run: chmod +x gradlew

      - name: Build KMP iOS frameworks (iosSimulatorArm64)
        run: |
          ./gradlew \
            :netpeek-sdk:linkDebugFrameworkIosSimulatorArm64 \
            :netpeek-ui:linkDebugFrameworkIosSimulatorArm64 \
            --no-daemon --stacktrace

      - name: Verify built frameworks
        run: |
          echo "=== netpeek-sdk ==="
          ls -la netpeek-sdk/build/bin/iosSimulatorArm64/debugFramework/
          echo "=== netpeek-ui ==="
          ls -la netpeek-ui/build/bin/iosSimulatorArm64/debugFramework/

      - name: Install tools (xcodegen + xcpretty)
        run: |
          brew install xcodegen
          gem install xcpretty --no-document 2>/dev/null || true

      - name: Generate Xcode project
        working-directory: iosApp
        run: xcodegen generate

      - name: Select simulator
        id: simulator
        run: |
          UDID=$(xcrun simctl list devices available -j | python3 -c "
          import json, sys
          data = json.load(sys.stdin)['devices']
          iphones = [
            d for rt, devs in data.items()
            for d in devs
            if 'iPhone' in d.get('name', '') and d.get('isAvailable') and 'iOS' in rt
          ]
          # prefer iPhone 16, fall back to any iPhone
          preferred = [d for d in iphones if 'iPhone 16' in d['name']]
          chosen = (preferred or iphones)[0] if (preferred or iphones) else None
          print(chosen['udid'] if chosen else '')
          ")
          echo "udid=$UDID" >> $GITHUB_OUTPUT
          echo "Chosen simulator: $UDID"
          xcrun simctl boot "$UDID" 2>/dev/null || true

      - name: Build app for simulator
        working-directory: iosApp
        run: |
          set -o pipefail
          xcodebuild build \
            -project NetPeekSample.xcodeproj \
            -scheme NetPeekSample \
            -sdk iphonesimulator \
            -destination "id=${{ steps.simulator.outputs.udid }}" \
            -configuration Debug \
            CODE_SIGNING_ALLOWED=NO \
          | xcpretty || true

      - name: Install and launch on simulator
        run: |
          APP=$(find ~/Library/Developer/Xcode/DerivedData \
            -name "NetPeekSample.app" -path "*/iphonesimulator*" 2>/dev/null | head -1)
          echo "App: $APP"
          xcrun simctl install "${{ steps.simulator.outputs.udid }}" "$APP"
          xcrun simctl launch  "${{ steps.simulator.outputs.udid }}" io.netpeek.sample.ios
          sleep 6

      - name: Screenshot — app launched
        run: |
          mkdir -p screenshots
          xcrun simctl io "${{ steps.simulator.outputs.udid }}" screenshot screenshots/01-launched.png

      - name: Screenshot — after wait
        run: |
          sleep 3
          xcrun simctl io "${{ steps.simulator.outputs.udid }}" screenshot screenshots/02-idle.png

      - name: Upload simulator screenshots
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: ios-simulator-screenshots
          path: screenshots/
          retention-days: 14

      - name: Upload logs on failure
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: build-logs
          path: ~/Library/Logs/DiagnosticReports/
          retention-days: 7
